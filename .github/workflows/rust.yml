name: Rust CI/CD

on:
  push:
    branches: ["*"]  # ç›‘å¬æ‰€æœ‰åˆ†æ”¯
  pull_request:
    branches: ["*"]  # ç›‘å¬æ‰€æœ‰åˆ†æ”¯çš„ PR

env:
  CARGO_TERM_COLOR: always
  BINARY_NAME: rustdesk_auto_config  # æ›¿æ¢ä¸ºä½ çš„äºŒè¿›åˆ¶æ–‡ä»¶åï¼ˆä¸å«æ‰©å±•åï¼‰
  PROJECT_NAME: RustDeskAutoConfig  # é¡¹ç›®æ˜¾ç¤ºåç§°

jobs:
  build_and_release:
    runs-on: windows-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»º/æ›´æ–° Release

    steps:
      - name: ğŸ§¾ Checkoutä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ å®‰è£…Rustå·¥å…·é“¾
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ› ï¸ æ„å»ºDebugç‰ˆæœ¬
        run: cargo build --verbose

      - name: ğŸ› ï¸ æ„å»ºReleaseç‰ˆæœ¬
        run: cargo build --release --verbose

      - name: ğŸ—“ï¸ ç”Ÿæˆæ—¥æœŸæˆ³ & åˆ†æ”¯å¤„ç†
        shell: pwsh
        run: |
          # è·å–åŸå§‹åˆ†æ”¯åå¹¶æ›¿æ¢éæ³•å­—ç¬¦
          $branch = "$env:GITHUB_REF_NAME"
          $safeBranch = $branch -replace '[\\/]', '_'
          
          # ç”Ÿæˆæ—¶é—´æˆ³
          $date = Get-Date -Format "yyyyMMdd-HHmmss"
          $sha = "$env:GITHUB_SHA".Substring(0,7)
          
          # å†™å…¥ç¯å¢ƒå˜é‡
          echo "BUILD_DATE=$date" >> $env:GITHUB_ENV
          echo "GIT_SHA=$sha" >> $env:GITHUB_ENV
          echo "BRANCH_NAME=$safeBranch" >> $env:GITHUB_ENV

      - name: ğŸ“ é‡å‘½åå¹¶æ•´ç†æ„å»ºäº§ç‰©
        shell: pwsh
        run: |
          # ç¡®ä¿ dist ç›®å½•å­˜åœ¨
          $distDir = "dist"
          New-Item -ItemType Directory -Path $distDir -Force
          
          $targetDir = "target"
          $debugDir = Join-Path $targetDir "debug"
          $releaseDir = Join-Path $targetDir "release"

          # æ„å»ºäº§ç‰©è·¯å¾„ï¼ˆä½¿ç”¨ Join-Path é¿å…è·¯å¾„æ‹¼æ¥é”™è¯¯ï¼‰
          $debugSrc = Join-Path $debugDir "${env:BINARY_NAME}.exe"
          $releaseSrc = Join-Path $releaseDir "${env:BINARY_NAME}.exe"

          # æ–‡ä»¶åæ ¼å¼ï¼šbranch-YYYYMMDD-SHA-type.exe
          $debugName = "${env:BRANCH_NAME}-${env:BUILD_DATE}-${env:GIT_SHA}-debug.exe"
          $releaseName = "${env:BRANCH_NAME}-${env:BUILD_DATE}-${env:GIT_SHA}-release.exe"

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if (-Not (Test-Path $debugSrc)) {
            Write-Error "Debug binary not found at $debugSrc"
            exit 1
          }
          if (-Not (Test-Path $releaseSrc)) {
            Write-Error "Release binary not found at $releaseSrc"
            exit 1
          }

          # é‡å‘½åå¹¶ç§»åŠ¨æ–‡ä»¶
          Rename-Item -Path $debugSrc -NewName $debugName
          Rename-Item -Path $releaseSrc -NewName $releaseName

          Move-Item -Path $debugDir\$debugName -Destination $distDir
          Move-Item -Path $releaseDir\$releaseName -Destination $distDir

          # å†™å…¥ç¯å¢ƒå˜é‡
          echo "DEBUG_FILENAME=$debugName" >> $env:GITHUB_ENV
          echo "RELEASE_FILENAME=$releaseName" >> $env:GITHUB_ENV

#      - name: ğŸ“ ä¸Šä¼ æ„å»ºäº§ç‰©åˆ°Artifacts
#        uses: actions/upload-artifact@v4
#        with:
#          name: builds-${{ env.BRANCH_NAME }}-${{ env.BUILD_DATE }}-${{ env.GIT_SHA }}
#          path: dist/

      - name: ğŸª„ åˆ›å»ºæˆ–æ›´æ–°é¢„å‘å¸ƒç‰ˆæœ¬
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # æ¯ä¸ªåˆ†æ”¯ä½¿ç”¨ç‹¬ç«‹ tagï¼Œå¦‚ auto-build-feature_test
          tag_name: auto-build-${{ env.BRANCH_NAME }}
          name: ğŸš€ ${{ env.PROJECT_NAME }} Auto-Build (${{ env.BRANCH_NAME }})
          body: |
            ğŸ“¦ è‡ªåŠ¨æ„å»ºç‰ˆæœ¬ - ${{ github.sha }}
            
            ğŸ“… æ„å»ºæ—¶é—´ï¼š${{ env.BUILD_DATE }}
            
            ğŸŒ¿ åˆ†æ”¯ï¼š${{ github.ref_name }}
            
            ğŸ”— ä¸‹è½½æœ€æ–°æ„å»ºäº§ç‰©ï¼š
            - [Debug ç‰ˆæœ¬](${{ github.repository }}/releases/download/auto-build-${{ env.BRANCH_NAME }}/${{ env.DEBUG_FILENAME }})
            - [Release ç‰ˆæœ¬](${{ github.repository }}/releases/download/auto-build-${{ env.BRANCH_NAME }}/${{ env.RELEASE_FILENAME }})
            
            ğŸ“„ å®Œæ•´æ„å»ºæ—¥å¿—ï¼š${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          prerelease: true
          files: |
            dist/${{ env.DEBUG_FILENAME }}
            dist/${{ env.RELEASE_FILENAME }}
